name: Keep Streamlit Alive (Playwright)

on:
  schedule:
    - cron: '0 */2 * * *' # 2ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:

jobs:
  run_playwright:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          # [ì¤‘ìš”] ì—¬ê¸°ì„œ MY_PATë¥¼ ì‚¬ìš©í•´ì•¼ ì´í›„ í‘¸ì‹œ(Push) ê¶Œí•œì´ ìƒê¹ë‹ˆë‹¤.
          token: ${{ secrets.MY_PAT }}
          # ë‚ ì§œ ê³„ì‚°ì„ ìœ„í•´ ì»¤ë°‹ ê¸°ë¡(History)ì„ ëª¨ë‘ ê°€ì ¸ì˜µë‹ˆë‹¤.
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Install Playwright Browsers
        run: |
          playwright install chromium

      - name: Run script
        run: python visit_app.py

      # --- [ìˆ˜ì •ëœ ë¶€ë¶„] ì™¸ë¶€ Action ëŒ€ì‹  ì§ì ‘ êµ¬í˜„í•œ ë¹„í™œì„±í™” ë°©ì§€ ë¡œì§ ---
      - name: Auto Commit if needed
        run: |
          # 1. ê¹ƒ ì„¤ì • (ê°€ìƒ ìœ ì € ì •ë³´)
          git config user.name "GitHub Action Bot"
          git config user.email "action@github.com"

          # 2. ë§ˆì§€ë§‰ ì»¤ë°‹ ë‚ ì§œ í™•ì¸
          last_commit_unix=$(git log -1 --format=%ct)
          current_unix=$(date +%s)
          seconds_diff=$((current_unix - last_commit_unix))
          days_diff=$((seconds_diff / 86400))

          echo "ğŸ“… ë§ˆì§€ë§‰ ì»¤ë°‹ìœ¼ë¡œë¶€í„° ${days_diff}ì¼ì´ ì§€ë‚¬ìŠµë‹ˆë‹¤."

          # 3. 50ì¼ì´ ì§€ë‚¬ë‹¤ë©´ ë¹ˆ ì»¤ë°‹ ìƒì„± í›„ í‘¸ì‹œ
          if [ $days_diff -gt 50 ]; then
            echo "âš ï¸ 50ì¼ ì œí•œì— ê·¼ì ‘í–ˆìŠµë‹ˆë‹¤. ìë™ ì»¤ë°‹ì„ ìƒì„±í•©ë‹ˆë‹¤..."
            
            # ë¹ˆ ì»¤ë°‹ ìƒì„± (--allow-empty ì˜µì…˜ ì‚¬ìš©)
            git commit --allow-empty -m "Keep alive: Automated activity check"
            
            # ë³€ê²½ì‚¬í•­ í‘¸ì‹œ
            git push
            echo "âœ… í‘¸ì‹œ ì™„ë£Œ! ì›Œí¬í”Œë¡œìš° ìˆ˜ëª…ì´ ì—°ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            echo "âœ… ì•„ì§ ì»¤ë°‹í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. (50ì¼ ë¯¸ë§Œ)"
          fi