name: Repo Activity Keepalive (Empty Commit)

on:
  workflow_dispatch:
  schedule:
    # 매일 03:17 UTC에 실행 (KST 12:17)
    # 실제로는 아래 조건(45일 경과)일 때만 커밋합니다.
    - cron: "17 3 * * *"

permissions:
  contents: write

jobs:
  empty-commit:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # 마지막 커밋 시간 확인을 위해 전체 히스토리 필요
          persist-credentials: true

      - name: Decide and commit if needed
        shell: bash
        run: |
          set -euo pipefail

          THRESHOLD_DAYS=45
          THRESHOLD_SEC=$((THRESHOLD_DAYS * 24 * 60 * 60))

          LAST_COMMIT_EPOCH="$(git log -1 --format=%ct)"
          NOW_EPOCH="$(date +%s)"
          AGE_SEC=$((NOW_EPOCH - LAST_COMMIT_EPOCH))

          echo "Last commit epoch: ${LAST_COMMIT_EPOCH}"
          echo "Now epoch:         ${NOW_EPOCH}"
          echo "Repo inactivity:   ${AGE_SEC} sec (threshold: ${THRESHOLD_SEC} sec)"

          if [ "${AGE_SEC}" -lt "${THRESHOLD_SEC}" ]; then
            echo "No action: last commit is within ${THRESHOLD_DAYS} days."
            exit 0
          fi

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git commit --allow-empty -m "chore: keepalive commit (automated)"

          # schedule 트리거는 기본 브랜치에서 실행됩니다.
          # 브랜치명을 안전하게 사용하기 위해 GITHUB_REF_NAME를 활용합니다.
          BRANCH="${GITHUB_REF_NAME:-main}"
          echo "Pushing to branch: ${BRANCH}"
          git push origin "HEAD:${BRANCH}"
